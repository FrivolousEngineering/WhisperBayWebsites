<html>
<style>
    * {
      font-size: 16px;
      font-family: Monospace;
    }
</style>
<head>
    <script src="jquery-3.7.1.min.js"></script>
</head>

<div id="questionsContainer">

</div>

<div id="message"></div>
<script>

    $(document).on("submit", "form", function(event)
    {
        event.preventDefault();

        var url=$(this).attr("action");
        $.ajax({
            url: url,
            type: $(this).attr("method"),
            dataType: "JSON",
            data: new FormData(this),
            processData: false,
            contentType: false,
            beforeSend: function()
            {
                $("#message").html("sending...");
                console.log("SENDING");
            },
            success: function(data)
            {
                $("#message").html("");
                getAllQuestions(); // Refresh all the data (yeah, inefficient AF, sue me)
            },
            error: function (xhr, description, error)
            {
                $("#message").html(xhr.responseText);
                $([document.documentElement, document.body]).animate({scrollTop: $("#message").offset().top}, 500);
            }
        });
    });

    function getAllQuestions() {
        $.get("http://localhost:8000/questions/", function (data) {
            updateTable(data);
        });
    }

    function updateTable(response) {
        // Clear the old data (if any!)
        $('#questionsContainer').empty();

        // Go over all the questions
        $.each(response, function (i, question) {
            var form = $("<form/>", {
                action: "http://localhost:8000/questions/" + question.id,
                method: "put"
            });

            // Change the text of the question
            form.append($("<label>", {}).text("Question text: "));
            form.append($("<input>", {
                type: "text",
                name: "text",
                value: question.text,
                disabled: question.required
            }));
            form.append($("<br>"))
            // Change the type of the question
            form.append($("<label>").text("Question Type: "));
            var select = $("<select>", {name:"type", disabled: question.required});

            select.append($("<option>", {value:"pickone", selected: question.type === "pickone"}).text("Pick one"));
            select.append($("<option>", {value:"freeform", selected: question.type === "freeform"}).text("Text"));
            select.append($("<option>", {value:"boolean", selected: question.type === "boolean"}).text("Boolean"));
            form.append(select);

            // Allow the multiple choice options to be changed
            if (question.type === "pickone") {
                var table = $("<table/>");
                var tr = $("<tr/>");
                var optionsHeader = $("<th>").text("options");
                if(!question.required){
                    // Allow for new questions to be added!
                    var addOptionButton = $("<button/>").text("Add Option");

                    addOptionButton.click(function(e){
                        e.preventDefault();
                        $.ajax({
                            url: "http://localhost:8000/questions/" + question.id + "/options/empty/",
                            type: "POST",
                            success: function(result) {
                                getAllQuestions(); // Refresh all the data (yeah, inefficient AF, sue me)
                            },
                        });
                    });
                    optionsHeader.append($("<br>"));
                    optionsHeader.append(addOptionButton);
                }

                tr.append(optionsHeader);
                var th = $("<th>");

                $.each(question.options, function (j, option) {
                    // Actually add the textfields to change the options!
                    th.append($("<input/>", {type:"text", name: "option_" + option.id, value: option.value, disabled: question.required}));
                    // Add a button that deletes the option
                    var deleteOptionButton = $("<button/>", {disabled: question.required}).text("X");
                    deleteOptionButton.click(function(e){
                        e.preventDefault();
                        $.ajax({
                            url: "http://localhost:8000/options/" + option.id + "/",
                            type: "DELETE",
                            success: function(result) {
                                getAllQuestions(); // Refresh all the data (yeah, inefficient AF, sue me)
                            },
                        });
                    });
                    th.append(deleteOptionButton);
                    th.append($("<br>"));
                });

                tr.append(th);
                table.append(tr);
                form.append(table);
            } else {
                form.append($("<br>"));
            }

            if(!question.required) {
                form.append($("<input>", {type: "submit", value: "save"}))
            }

            form.appendTo("#questionsContainer");

            // Form to delete the question
            if(!question.required) {
                var deleteQuestionForm = $("<form/>", {
                    action: "http://localhost:8000/questions/" + question.id,
                    method: "delete"
                });
                deleteQuestionForm.append($("<input>", {type: "submit", value: "Delete Question"}))
                deleteQuestionForm.appendTo("#questionsContainer");
            }
            $("<hr>").appendTo("#questionsContainer");
        });

        // Button to add a new question that is at the bottom of the form!
        var newQuestionForm = $("<form/>", {
            action: "http://localhost:8000/questions/empty/",
            method: "post"
        });
        newQuestionForm.append($("<input>", {type: "submit", value: "addQuestion"}))
        newQuestionForm.appendTo("#questionsContainer");
    }

    getAllQuestions();

</script>
</html>
